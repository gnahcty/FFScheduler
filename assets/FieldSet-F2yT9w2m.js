import{d as z,a as S,n as G,c as J,b as q,e as K,f as P,i as Q}from"./index-DroqAkUS.js";import{j as m,i as N,N as W,u as Z,x as I,a8 as ee,q as te,s as R,a1 as A,a4 as ne,m as se,g,o as b,c as O,a as y,t as j,X as F,r as oe,l as ie,b as re,w as le,F as ae,e as ce,f as ue,_ as de}from"./index-Cq4_Sw1c.js";import{f as fe}from"./format-D4DUqj0R.js";function V(t){var n;const e=S(t);return(n=e==null?void 0:e.$el)!=null?n:e}const ve=Q?window:void 0;function M(...t){let n,e,i,a;if(typeof t[0]=="string"||Array.isArray(t[0])?([e,i,a]=t,n=ve):[n,e,i,a]=t,!n)return G;Array.isArray(e)||(e=[e]),Array.isArray(i)||(i=[i]);const s=[],o=()=>{s.forEach(f=>f()),s.length=0},l=(f,d,p,h)=>(f.addEventListener(d,p,h),()=>f.removeEventListener(d,p,h)),u=W(()=>[V(n),S(a)],([f,d])=>{if(o(),!f)return;const p=J(d)?{...d}:d;s.push(...e.flatMap(h=>i.map(c=>l(f,h,c,p))))},{immediate:!0,flush:"post"}),w=()=>{u(),o()};return q(w),w}const me=500,pe=10;function U(t,n,e){var i,a;const s=m(()=>V(t));let o,l;function u(){o&&(clearTimeout(o),o=void 0),l=void 0}function w(c){var x,_,L,k;(x=e==null?void 0:e.modifiers)!=null&&x.self&&c.target!==s.value||(u(),(_=e==null?void 0:e.modifiers)!=null&&_.prevent&&c.preventDefault(),(L=e==null?void 0:e.modifiers)!=null&&L.stop&&c.stopPropagation(),l={x:c.x,y:c.y},o=setTimeout(()=>n(c),(k=e==null?void 0:e.delay)!=null?k:me))}function f(c){var x,_,L,k;if((x=e==null?void 0:e.modifiers)!=null&&x.self&&c.target!==s.value||!l||(e==null?void 0:e.distanceThreshold)===!1)return;(_=e==null?void 0:e.modifiers)!=null&&_.prevent&&c.preventDefault(),(L=e==null?void 0:e.modifiers)!=null&&L.stop&&c.stopPropagation();const C=c.x-l.x,E=c.y-l.y;Math.sqrt(C*C+E*E)>=((k=e==null?void 0:e.distanceThreshold)!=null?k:pe)&&u()}const d={capture:(i=e==null?void 0:e.modifiers)==null?void 0:i.capture,once:(a=e==null?void 0:e.modifiers)==null?void 0:a.once},p=[M(s,"pointerdown",w,d),M(s,"pointermove",f,d),M(s,["pointerup","pointerleave"],u,d)];return()=>p.forEach(c=>c())}const ge={[z.mounted](t,n){typeof n.value=="function"?U(t,n.value,{modifiers:n.modifiers}):U(t,...n.value)}};function $(t){return typeof Window<"u"&&t instanceof Window?t.document.documentElement:typeof Document<"u"&&t instanceof Document?t.documentElement:t}function Y(t){const n=window.getComputedStyle(t);if(n.overflowX==="scroll"||n.overflowY==="scroll"||n.overflowX==="auto"&&t.clientWidth<t.scrollWidth||n.overflowY==="auto"&&t.clientHeight<t.scrollHeight)return!0;{const e=t.parentNode;return!e||e.tagName==="BODY"?!1:Y(e)}}function he(t){const n=t||window.event,e=n.target;return Y(e)?!1:n.touches.length>1?!0:(n.preventDefault&&n.preventDefault(),!1)}const D=new WeakMap;function _e(t,n=!1){const e=N(n);let i=null;W(K(t),o=>{const l=$(S(o));if(l){const u=l;D.get(u)||D.set(u,u.style.overflow),e.value&&(u.style.overflow="hidden")}},{immediate:!0});const a=()=>{const o=$(S(t));!o||e.value||(P&&(i=M(o,"touchmove",l=>{he(l)},{passive:!1})),o.style.overflow="hidden",e.value=!0)},s=()=>{var o;const l=$(S(t));!l||!e.value||(P&&(i==null||i()),l.style.overflow=(o=D.get(l))!=null?o:"",D.delete(l),e.value=!1)};return q(s),m({get(){return e.value},set(o){o?a():s()}})}function ye(){let t=!1;const n=N(!1);return(e,i)=>{if(n.value=i.value,t)return;t=!0;const a=_e(e,i.value);W(n,s=>a.value=s)}}ye();const we=t=>{const n=Z(),e=I(),i=ee(),a=te(),s=R(),o=(r,v,H="",T=1e3)=>{e.add({severity:r,summary:v,detail:H,life:T})},l=()=>(n.isLoggedIn||(o("error","請先登入"),a.push("/login")),n.isLoggedIn),u=async r=>{try{if(!l())return;await r(),s.getList()}catch(v){console.log(v),o("error","錯誤",v.message)}},w=async r=>{await u(async()=>await A.post("/list/hide",{id:r})),o("success","場次已刪除")},f=async r=>{await u(async()=>await A.post("/list/unhide",{id:r})),o("success","場次已復原")},d=r=>{i.require({message:"鎖定後，此電影其他場次將被刪除，確定要鎖定嗎？",header:"鎖定場次",rejectClass:"p-button-text",acceptClass:"p-button-success p-button-text",accept:async()=>{await u(async()=>await A.post("/list/lock",{id:r,filmID:_.value})),console.log("locked"),o("success","已鎖定")},reject:()=>o("error","已取消")})},p=r=>new Promise(v=>{i.require({message:"解除鎖定後，此電影其他場次將被復原，確定要解除鎖定嗎？",header:"解除鎖定",rejectClass:"p-button-text",acceptClass:"p-button-danger p-button-text",accept:async()=>{await u(async()=>await A.post("/list/unlock",{id:r,filmID:_.value})),o("success","已解除鎖定"),v()},reject:()=>{o("error","已取消"),v()}})}),h=m(()=>s.userList.find(r=>r._id===t)),c=m(()=>s.userList.filter(r=>r.screening.film._id===_.value&&!r.hidden)),x=m(()=>c.value.length),_=m(()=>h.value.screening.film._id),L=m(()=>c.value.some(r=>r.locked)),k=m(()=>h.value.hidden),C=()=>{s.userList.find(v=>v._id===t).locked?p(t):d(t)},E=async()=>{const r=s.userList.find(v=>v._id===t);L.value&&await p(t),r.hidden?await f(t):await w(t)},B=m(()=>{const r=s.userList.find(X=>X._id===t),v=r.locked?"bg-stone-200":"",H=r.locked?"text-stone-900":r.hidden?"text-stone-600":x.value<=2?"text-orange-500":"text-white",T=r.hidden?"border border-stone-600":r.clash>0?"border border-red-600 ring-1 ring-inset ring-red-700":"border";return`${v} ${H} ${T}`});return{targetList:h,remainingScreening:x,lock:C,hide:E,chipStyle:B,isHidden:k}},xe={class:"font-bold"},Le={__name:"ScreeningChip",props:{screening:{},screeningModifiers:{}},emits:["update:screening"],setup(t){const n=ne(t,"screening"),e=we(n.value.list_id);return(i,a)=>se((b(),O("button",{class:F(["my-btn text-sm",g(e).chipStyle.value]),onClick:a[0]||(a[0]=s=>g(e).hide())},[y("span",xe,j(g(fe)(n.value.time,"MM.dd EEE HH:mm")),1)],2)),[[g(ge),[()=>g(e).lock(),{modifiers:{stop:!0}}]]])}},ke=t=>{const n=R(),e=m(()=>n.userList.filter(s=>s.screening.film._id===t&&!s.hidden)),i=m(()=>e.value.some(s=>s.locked)),a=m(()=>e.value.some(s=>s.clash>0));return{remainingScreening:e,filmLocked:i,filmClashed:a}},be={class:"border-gray-200 text-white transition-all duration-500"},Se={class:"flex items-center"},Ce={key:0,class:"pi pi-lock pe-3 text-xs"},Ee={class:"flex flex-col items-end"},Ae={class:"isolate pb-2 text-right text-xs text-stone-200 transition-all"},De={class:"grid grid-cols-2 gap-4 pb-2 xl:grid-cols-3"},Te={__name:"FieldSet",props:{film:{type:Object,default:()=>{}}},setup(t){const n=t,e=ke(n.film._id),i=N(!1),a=()=>i.value=!i.value,s=n.film.screenings;return(o,l)=>{const u=oe("router-link"),w=Le;return b(),O("div",be,[y("button",{onClick:l[0]||(l[0]=f=>a()),class:"flex w-full items-center justify-between p-2 pb-0 text-left text-3xl font-bold"},[y("div",Se,[g(e).filmLocked.value?(b(),O("span",Ce)):ie("",!0),re(u,{to:`/details/${n.film._id}`},{default:le(()=>[y("span",{class:F(["hover:underline",{"text-stone-700":g(e).remainingScreening.value.length===0}])},j(n.film.CName),3)]),_:1},8,["to"])]),y("div",Ee,[y("div",{class:F(["pi",i.value?"pi-minus":"pi-plus"])},null,2)])]),y("div",{class:"overflow-hidden px-2 transition-all duration-300",style:de({maxHeight:i.value?"100vh":"0px"})},[y("div",Ae," 剩餘場次:"+j(g(e).remainingScreening.value.length),1),y("div",De,[(b(!0),O(ae,null,ce(g(s),(f,d)=>(b(),ue(w,{key:f.list_id,screening:g(s)[d],"onUpdate:screening":p=>g(s)[d]=p},null,8,["screening","onUpdate:screening"]))),128))])],4)])}}};export{Te as _,we as m,ge as v};
